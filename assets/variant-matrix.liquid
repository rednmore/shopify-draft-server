{%- comment -%}
  Affiche une matrice achat : Toutes les Couleurs -> (Taille, Qty) -> Validate/Cancel
  Hypothèse : options = Couleur/Color & Taille/Size (noms localisés)
{%- endcomment -%}

{%- liquid
  assign color_idx = 0
  assign size_idx  = 0
  assign o1 = product.options[0] | downcase
  assign o2 = product.options[1] | downcase
  assign o3 = product.options[2] | downcase

  if o1 contains 'couleur' or o1 contains 'color'
    assign color_idx = 1
  elsif o2 contains 'couleur' or o2 contains 'color'
    assign color_idx = 2
  elsif o3 contains 'couleur' or o3 contains 'color'
    assign color_idx = 3
  endif

  if o1 contains 'taille' or o1 contains 'size'
    assign size_idx = 1
  elsif o2 contains 'taille' or o2 contains 'size'
    assign size_idx = 2
  elsif o3 contains 'taille' or o3 contains 'size'
    assign size_idx = 3
  endif
-%}

{%- if color_idx == 0 or size_idx == 0 -%}
  {%- render 'product-form', product: product -%}
  {%- break -%}
{%- endif -%}

{%- comment -%} Collecte des couleurs uniques {%- endcomment -%}
{%- assign colors_str = '' -%}
{%- for v in product.variants -%}
  {%- assign cval = v[ 'option' | append: color_idx ] -%}
  {%- unless colors_str contains cval -%}
    {%- assign colors_str = colors_str | append: cval | append: '||' -%}
  {%- endunless -%}
{%- endfor -%}
{%- assign colors = colors_str | split: '||' | uniq | compact -%}

<div class="vmatrix" data-product-id="{{ product.id }}">
  {%- for color in colors -%}
    {%- if color != '' -%}
      <div class="vmatrix__color-block" data-color="{{ color | escape }}">
        <h4 class="vmatrix__color-title">{{ color }}</h4>

        {%- comment -%} tailles disponibles pour cette couleur {%- endcomment -%}
        {%- assign sizes_str = '' -%}
        {%- for v in product.variants -%}
          {%- if v[ 'option' | append: color_idx ] == color -%}
            {%- assign sval = v[ 'option' | append: size_idx ] -%}
            {%- unless sizes_str contains sval -%}
              {%- assign sizes_str = sizes_str | append: sval | append: '||' -%}
            {%- endunless -%}
          {%- endif -%}
        {%- endfor -%}
        {%- assign sizes = sizes_str | split: '||' | uniq | compact -%}

        <div class="vmatrix__rows">
          {%- for s in sizes -%}
            {%- assign the_variant = nil -%}
            {%- for v in product.variants -%}
              {%- if v[ 'option' | append: color_idx ] == color and v[ 'option' | append: size_idx ] == s -%}
                {%- assign the_variant = v -%}{%- break -%}
              {%- endif -%}
            {%- endfor -%}

            {%- if the_variant -%}
              <div class="vmatrix__row" data-variant-id="{{ the_variant.id }}">
                <span class="vmatrix__size">{{ s }}</span>
                {%- if the_variant.available -%}
                  <input class="vmatrix__qty" type="number" min="0" step="1" value="0" inputmode="numeric" aria-label="{{ color }} / {{ s }} qty">
                {%- else -%}
                  <span class="vmatrix__oos">{{ 'products.product.sold_out' | t }}</span>
                {%- endif -%}
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  {%- endfor -%}

  <div class="vmatrix__actions">
    <button type="button" class="button button--primary vmatrix__validate">
      {{ 'products.product.add_to_cart' | t | default: 'Valider' }}
    </button>
    <button type="button" class="button button--secondary vmatrix__cancel" data-action="close">
      {{ 'general.cancel' | t | default: 'Cancel' }}
    </button>
  </div>
</div>

<style>
  .vmatrix__color-block { padding: .75rem 0; border-top: 1px solid rgba(0,0,0,.08); }
  .vmatrix__color-title { margin: .25rem 0 .5rem; font-weight: 600; }
  .vmatrix__row { display:flex; align-items:center; gap:.75rem; padding:.25rem 0; }
  .vmatrix__size { min-width: 4rem; }
  .vmatrix__qty { width: 5.5rem; }
  .vmatrix__oos { opacity:.6; }
  .vmatrix__actions { display:flex; gap:.5rem; margin-top: .75rem; }
</style>
