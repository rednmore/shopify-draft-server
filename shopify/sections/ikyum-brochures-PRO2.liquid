{% assign lang = request.locale.iso_code | downcase %}

{%- liquid
  assign stack_mobile = section.settings.stack_collections_mobile
  assign stack_desktop = section.settings.stack_collections
  assign stack_mobile_and_desktop = false

  if stack_desktop and stack_mobile
    assign stack_mobile_and_desktop = true
  endif
-%}

<style>
  #shopify-section-{{ section.id }}{
    {%- if stack_mobile or stack_mobile_and_desktop -%}
      --collection-list-items-per-row: {{ section.settings.collections_per_row_mobile | times: 1 }};
    {%- else -%}
      --collection-list-item-size: 84vw;
    {%- endif -%}

    {%- if section.settings.space_items -%}
      --collection-list-gap: 1.5rem;
    {%- endif -%}
  }

  @media screen and (min-width: 700px){
    #shopify-section-{{ section.id }}{
      {%- if stack_mobile or stack_mobile_and_desktop -%}
        --collection-list-items-per-row: {{ 2 | at_most: section.settings.collections_per_row_desktop }};
      {%- else -%}
        --collection-list-item-size: 62vw;
      {%- endif -%}
    }
  }

  @media screen and (min-width: 1150px){
    #shopify-section-{{ section.id }}{
      --collection-list-item-size: unset;
      --collection-list-items-per-row: {{ section.settings.collections_per_row_desktop }};
      {%- if section.settings.space_items -%}
        --collection-list-gap: 1.875rem;
      {%- endif -%}
    }
  }

  /* --- Forcer le rendu “plein visuel” + texte visible d’emblée --- */
  #shopify-section-{{ section.id }} .content-over-media{
    position: relative;
  }
  #shopify-section-{{ section.id }} .content-over-media__image{
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  /* Assurer que le bloc de contenu est visible sans hover */
  #shopify-section-{{ section.id }} .collection-card__content{
    opacity: 1;
    visibility: visible;
  }
</style>

{%- assign reduce_vertical_spacing = false -%}
{%- assign remove_vertical_spacing = false -%}
{%- if section.settings.subheading == blank and section.settings.title == blank and section.settings.content == blank -%}
  {%- assign reduce_vertical_spacing = true -%}
  {%- unless section.settings.space_items -%}
    {%- assign remove_vertical_spacing = true -%}
  {%- endunless -%}
{%- endif -%}

{%- assign color_scheme_hash = section.settings.color_scheme.settings.background_gradient | default: section.settings.color_scheme.settings.background | md5 -%}

<div class="{% unless remove_vertical_spacing %}section-spacing {% if reduce_vertical_spacing %}section-spacing--tight{% endif %}{% endunless %} color-scheme color-scheme--{{ section.settings.color_scheme.id }} color-scheme--bg-{{ color_scheme_hash }} {% if section.settings.separate_section_with_border %}bordered-section{% endif %}">
  <div class="{% if section.settings.space_items %}container{% endif %}">
    <div class="section-stack">
      {%- render 'section-header',
        subheading: section.settings.subheading,
        heading: section.settings.title,
        content: section.settings.content,
        text_alignment: 'center'
      -%}

      {%- capture card_list -%}
        {%- for block in section.blocks -%}
          {%- comment -%} -- i18n PDF URL (FR/DE/EN with fallbacks) -- {%- endcomment -%}
          {%- assign pdf_fr = block.settings.pdf_url_fr -%}
          {%- assign pdf_en = block.settings.pdf_url_en -%}
          {%- assign pdf_de = block.settings.pdf_url_de -%}
          {%- assign pdf_legacy = block.settings.pdf_url -%}

          {%- assign pdf = '' -%}
          {%- case lang -%}
            {%- when 'fr' -%}{%- assign pdf = pdf_fr | default: pdf_en | default: pdf_de | default: pdf_legacy -%}
            {%- when 'de' -%}{%- assign pdf = pdf_de | default: pdf_en | default: pdf_fr | default: pdf_legacy -%}
            {%- else -%}{%- assign pdf = pdf_en | default: pdf_fr | default: pdf_de | default: pdf_legacy -%}
          {%- endcase -%}

          {%- comment -%} -- i18n Title / Tagline -- {%- endcomment -%}
          {%- assign name_fr = block.settings.name_fr -%}
          {%- assign name_en = block.settings.name_en -%}
          {%- assign name_de = block.settings.name_de -%}
          {%- assign name_default = block.settings.name -%}

          {%- assign title_txt = '' -%}
          {%- case lang -%}
            {%- when 'fr' -%}{%- assign title_txt = name_fr | default: name_en | default: name_de | default: name_default -%}
            {%- when 'de' -%}{%- assign title_txt = name_de | default: name_en | default: name_fr | default: name_default -%}
            {%- else -%}{%- assign title_txt = name_en | default: name_fr | default: name_de | default: name_default -%}
          {%- endcase -%}

          {%- assign tag_fr = block.settings.tagline_fr -%}
          {%- assign tag_en = block.settings.tagline_en -%}
          {%- assign tag_de = block.settings.tagline_de -%}
          {%- assign tag_default = block.settings.tagline -%}

          {%- assign tag_txt = '' -%}
          {%- case lang -%}
            {%- when 'fr' -%}{%- assign tag_txt = tag_fr | default: tag_en | default: tag_de | default: tag_default -%}
            {%- when 'de' -%}{%- assign tag_txt = tag_de | default: tag_en | default: tag_fr | default: tag_default -%}
            {%- else -%}{%- assign tag_txt = tag_en | default: tag_fr | default: tag_de | default: tag_default -%}
          {%- endcase -%}

          {%- comment -%} -- i18n Button label (block → global fallback) -- {%- endcomment -%}
          {%- assign btn_fr = block.settings.btn_label_fr -%}
          {%- assign btn_en = block.settings.btn_label_en -%}
          {%- assign btn_de = block.settings.btn_label_de -%}
          {%- assign btn_single = block.settings.btn_label -%}
          {%- assign btn_global_fr = section.settings.btn_label_fr -%}
          {%- assign btn_global_en = section.settings.btn_label_en -%}
          {%- assign btn_global_de = section.settings.btn_label_de -%}
          {%- assign btn_global_single = section.settings.btn_label -%}

          {%- assign btn_txt = '' -%}
          {%- case lang -%}
            {%- when 'fr' -%}{%- assign btn_txt = btn_fr | default: btn_en | default: btn_de | default: btn_single | default: btn_global_fr | default: btn_global_en | default: btn_global_de | default: btn_global_single | default: 'Lire' -%}
            {%- when 'de' -%}{%- assign btn_txt = btn_de | default: btn_en | default: btn_fr | default: btn_single | default: btn_global_de | default: btn_global_en | default: btn_global_fr | default: btn_global_single | default: 'Lesen' -%}
            {%- else -%}{%- assign btn_txt = btn_en | default: btn_fr | default: btn_de | default: btn_single | default: btn_global_en | default: btn_global_fr | default: btn_global_de | default: btn_global_single | default: 'Read' -%}
          {%- endcase -%}

          {%- assign image = block.settings.thumb_image -%}

          {%- capture card_info -%}
            <div class="content-over-media__content collection-card__content color-scheme color-scheme--{{ block.settings.color_scheme.id }} prose prose--tight {{ block.settings.content_position }}">
              {%- if tag_txt != blank -%}
                <p class="h6">{{- tag_txt -}}</p>
              {%- endif -%}
              {%- if title_txt != blank -%}
                <p class="h3">{{- title_txt -}}</p>
              {%- endif -%}
             {%- assign button_label = btn_txt -%}
{%- if button_label == blank -%}
  {%- case lang -%}
    {%- when 'fr' -%}{%- assign button_label = 'Lire' -%}
    {%- when 'de' -%}{%- assign button_label = 'Lesen' -%}
    {%- else -%}{%- assign button_label = 'Read' -%}
  {%- endcase -%}
{%- endif -%}

{%- assign button_href = pdf | default: '#' -%}

{%- render 'button',
  type: 'link',
  content: button_label,
  style: block.settings.button_style,
  href: button_href,
  target: '_self',
  focusable: true
-%}

            </div>
          {%- endcapture -%}

          {%- capture card_image -%}
            {%- if image != blank -%}
              {{ image
                | image_url: width: image.width
                | image_tag:
                  class: 'content-over-media__image zoom-image',
                  loading: 'lazy',
                  width: image.width,
                  height: image.height,
                  sizes: '100vw',
                  widths: '400,600,800,1000,1200,1400,1600,1800,2000,2200,2400' }}
            {%- else -%}
              {%- capture collection_placeholder -%}{%- cycle 'collection-1', 'collection-2', 'collection-3' -%}{%- endcapture -%}
              {{- collection_placeholder | placeholder_svg_tag: 'placeholder zoom-image' | replace: '<svg', '<svg preserveAspectRatio="xMinYMin slice"' -}}
            {%- endif -%}
          {%- endcapture -%}

          {%- capture card_inner -%}
            <div class="content-over-media content-over-media--{{ section.settings.image_size | default: 'md' }}" style="--content-over-media-overlay: {{ block.settings.overlay_color.rgb }} / {{ block.settings.overlay_opacity | divided_by: 100.0 }};">
              {{- card_image -}}
              {%- unless section.settings.show_text_outside -%}
                {{- card_info -}}
              {%- endunless -%}
            </div>
            {%- if section.settings.show_text_outside -%}
              {{- card_info -}}
            {%- endif -%}
          {%- endcapture -%}

          {%- assign card_classes = 'collection-card ' -%}
          {%- if block.settings.expand_collection -%}{% assign card_classes = card_classes | append: 'grow ' %}{% endif -%}
          {%- unless stack_mobile_and_desktop -%}{% assign card_classes = card_classes | append: 'shrink-0 snap-center ' %}{% endunless -%}
          {%- if forloop.first -%}{% assign card_classes = card_classes | append: 'is-selected ' %}{% endif -%}
          {%- assign card_classes = card_classes | append: 'group' -%}

          {%- if pdf != blank -%}
            <a href="{{ pdf }}" class="{{ card_classes }}" {{ block.shopify_attributes }}>
              {{- card_inner -}}
            </a>
          {%- else -%}
            <div class="{{ card_classes }}" {{ block.shopify_attributes }}>
              {{- card_inner -}}
            </div>
          {%- endif -%}
        {%- endfor -%}
      {%- endcapture -%}

      <div class="collection-list wrap {% if section.settings.show_text_outside %}collection-list--text-outside{% endif %}">
        {{ card_list }}
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "IKYUM brochures PRO2",
  "tag": "section",
  "class": "shopify-section--collection-list",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header","custom.overlay"]
  },
  "settings": [
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "checkbox", "id": "separate_section_with_border", "label": "Separate with border", "default": true },

    { "type": "select", "id": "image_size", "label": "Image size", "options": [
      { "value": "auto", "label": "Original ratio" },
      { "value": "xs", "label": "X small" },
      { "value": "sm", "label": "Small" },
      { "value": "md", "label": "Medium" },
      { "value": "lg", "label": "Large" }
    ], "default": "md" },

    { "type": "checkbox", "id": "show_text_outside", "label": "Show text under image", "default": false },
    { "type": "checkbox", "id": "space_items", "label": "Add space between cards", "default": true },

    { "type": "checkbox", "id": "stack_collections", "label": "Grid on desktop", "default": true },
    { "type": "range", "id": "collections_per_row_desktop", "min": 1, "max": 5, "label": "Cards per row (desktop)", "default": 3 },

    { "type": "checkbox", "id": "stack_collections_mobile", "label": "Grid on mobile", "default": true },
    { "type": "select", "id": "collections_per_row_mobile", "label": "Cards per row (mobile)", "options": [
      { "value": "1", "label": "1" },
      { "value": "2", "label": "2" }
    ], "default": "1" },

    { "type": "header", "content": "Header" },
    { "type": "inline_richtext", "id": "subheading", "label": "Subheading" },
    { "type": "inline_richtext", "id": "title", "label": "Heading" },
    { "type": "richtext", "id": "content", "label": "Content" },

    { "type": "header", "content": "Global button labels (fallbacks)" },
    { "type": "text", "id": "btn_label_fr", "label": "Button FR", "default": "Lire" },
    { "type": "text", "id": "btn_label_en", "label": "Button EN", "default": "Read" },
    { "type": "text", "id": "btn_label_de", "label": "Button DE", "default": "Lesen" },
    { "type": "text", "id": "btn_label", "label": "Button (legacy fallback)" }
  ],
  "blocks": [
    {
      "type": "brochure",
      "name": "Brochure",
      "settings": [
        { "type": "color_scheme", "id": "color_scheme", "label": "Card color scheme", "default": "scheme-4" },

        { "type": "image_picker", "id": "thumb_image", "label": "Thumbnail image" },

        { "type": "select", "id": "content_position", "label": "Content position", "options": [
          { "value": "place-self-start text-start", "label": "Top left" },
          { "value": "place-self-start-center text-center", "label": "Top center" },
          { "value": "place-self-start-end text-end", "label": "Top right" },
          { "value": "place-self-center-start text-start", "label": "Middle left" },
          { "value": "place-self-center text-center", "label": "Middle center" },
          { "value": "place-self-center-end text-end", "label": "Middle right" },
          { "value": "place-self-end-start text-start", "label": "Bottom left" },
          { "value": "place-self-end-center text-center", "label": "Bottom center" },
          { "value": "place-self-end text-end", "label": "Bottom right" }
        ], "default": "place-self-end-start text-start" },

        { "type": "inline_richtext", "id": "name_fr", "label": "Title FR" },
        { "type": "inline_richtext", "id": "name_en", "label": "Title EN" },
        { "type": "inline_richtext", "id": "name_de", "label": "Title DE" },
        { "type": "inline_richtext", "id": "name", "label": "Title (fallback)" },

        { "type": "inline_richtext", "id": "tagline_fr", "label": "Tagline FR" },
        { "type": "inline_richtext", "id": "tagline_en", "label": "Tagline EN" },
        { "type": "inline_richtext", "id": "tagline_de", "label": "Tagline DE" },
        { "type": "inline_richtext", "id": "tagline", "label": "Tagline (fallback)" },

        { "type": "url", "id": "pdf_url_fr", "label": "PDF FR URL" },
        { "type": "url", "id": "pdf_url_en", "label": "PDF EN URL" },
        { "type": "url", "id": "pdf_url_de", "label": "PDF DE URL" },
        { "type": "url", "id": "pdf_url", "label": "PDF URL (fallback)" },

        { "type": "text", "id": "btn_label_fr", "label": "Button FR" },
        { "type": "text", "id": "btn_label_en", "label": "Button EN" },
        { "type": "text", "id": "btn_label_de", "label": "Button DE" },
        { "type": "text", "id": "btn_label", "label": "Button (fallback)" },

        { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
        { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 30 },

        { "type": "checkbox", "id": "expand_collection", "label": "Expand to fill row (when grid)", "default": false },

        { "type": "select", "id": "button_style", "label": "Button style", "options": [
          { "value": "outline", "label": "Outline" },
          { "value": "solid", "label": "Solid" },
          { "value": "link", "label": "Link" }
        ], "default": "solid" }
      ]
    }
  ],
  "max_blocks": 50,
  "presets": [
    { "name": "IKYUM brochures PRO2" }
  ]
}
{% endschema %}
